---
import Layout from "../layouts/Layout.astro";
import Redirects from "../pages/Redirects.astro";
import Moving from "./Moving.astro";

export const prerender = false;

const res = await fetch('https://api.github.com/users/tarfish/repos');
const repos: any[] = await res.json();
const latestRepos = repos
  .sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime())
  .slice(0, 5);

const commitHash = import.meta.env.VERCEL_GIT_COMMIT_SHA
  ? import.meta.env.VERCEL_GIT_COMMIT_SHA.slice(0, 7)
  : "dev";

const commitDateRaw = import.meta.env.VERCEL_GIT_COMMIT_TIMESTAMP
  ? new Date(import.meta.env.VERCEL_GIT_COMMIT_TIMESTAMP).toISOString().split("T")[0]
  : new Date().toISOString().split("T")[0];

const date = new Date(commitDateRaw);
const commitDate = date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});
---
<Layout title="projects">
  <header><b>my projects!</b></header>

  <main class="flex-grow">
    <br>
    <Moving />
    <div class="mt-12 mx-5 gap-8">
      <div class="p-12 py-4 bg-gradient-to-br from-blue-400 via-blue-500 to-blue-700 border-4 border-blue-900 justify-center items-center flex flex-col text-xl text-white">
        <Redirects />
      </div>

      <br>

      <div class="p-12 py-4 bg-gradient-to-br from-blue-400 via-blue-500 to-blue-700 border-4 border-blue-900 justify-center flex flex-col text-lg text-white card-3d">
        <p>5 latest repos pulled straight from github!</p>
        {latestRepos.map((repo) => (
          <div class="mb-6">
            <h2 class="text-2xl"><a href={repo.html_url} target="_blank">{repo.name}</a></h2>
            <p class="mt-2">{repo.description}</p>
          </div>
        ))}
      </div>
    </div>
  </main>

  <footer class="text-center">
    <span class="lowercase">
      by sarvesh, Last updated: {commitDate} (commit {commitHash})
    </span>
  </footer>

  <script type="module" client:load>
    document.querySelectorAll(".card-3d").forEach(card => {
      let cx = 0, cy = 0, tx = 0, ty = 0;
      const max = 7, ease = 0.1, depth = 10;

      const loop = () => {
        cx += (tx - cx) * ease;
        cy += (ty - cy) * ease;
        card.style.transform = `
          perspective(1200px)
          rotateX(${cx}deg)
          rotateY(${cy}deg)
          translateZ(${depth}px)
        `;
        requestAnimationFrame(loop);
      };

      loop();

      card.addEventListener("mousemove", e => {
        const r = card.getBoundingClientRect();
        tx = -((e.clientY - r.top) / r.height - 0.5) * max;
        ty = ((e.clientX - r.left) / r.width - 0.5) * max;
      });

      card.addEventListener("mouseleave", () => { tx = 0; ty = 0; });
    });
  </script>
</Layout>